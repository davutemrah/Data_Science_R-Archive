---
title: "Storm Data in the U.S."
output:
    html_document:
        keep_md: true
        toc: true

knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, 
  output_dir = "html_output") })
---

# Most Effective Disasters in the US

## Abstract

This project analyzes storm data from U.S. National Oceanic and Atmospheric Administration's (NOAA). Data covers years from 1950 till 2011. It contains detailed information on every type of events occurred in the US. Many of these severe weather conditions result in fatalities, injuries, economic damages on the households. In this study, I find that tornadoes have caused the most fatalities and injuries, on the other hand floods has had the most economic damage.


```{r setup}
rm(list = ls())
knitr::opts_chunk$set(echo = TRUE)

if (!dir.exists("rawdata")) {dir.create("rawdata")}
if (!dir.exists("docs")) {dir.create("docs")}
```

```{r libraries}
library(dplyr, warn.conflicts = F)
library(ggplot2)
library(tidyr)
```

### Data Processing

Storm Data is downloaded from the website and stored in the local machine. For the sake of reproducibility, link to the dataset is stored as well in the document.
```{r datadownload, cache=TRUE}
data_url <- "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2" 
if(!file.exists("./rawdata/rawdata.zip")) {download.file(data_url, destfile = "./rawdata/rawdata.zip")}
stormdata <- read.csv("./rawdata/rawdata.zip")
```


```{r datadownload, cache=TRUE}
docurl <- "https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2Fpd01016005curr.pdf"
download.file(docurl, destfile = "docs/stormdata_docs.pdf")
```

Processing raw data is required before I analyze. Property and crop damage variables are recoded so that I can calculate the damage in dollar terms. Beginning date variable is also formatted. 

```{r, echo=TRUE}
df <-
stormdata %>%
    mutate( propexp = recode(PROPDMGEXP, 
                             K = 10^3, M = 10^6, B = 10^9,
                             m = 10^6, "+" = 10, "0" = 1,
                             "5" = 10^5, "6"= 10^6, "4" = 10^4,
                             "2" = 10^2, "3" = 10^3, h = 10^2,
                             "7" = 10^7, H = 10^2, "1" = 10, 
                             "8" = 10^8, .default = 1),
            PROPDMG = PROPDMG * propexp,
            cropexp = recode(CROPDMGEXP,
                             M = 10^6, K = 10^3, m = 10^6,
                             B = 10^9, k = 10^3, "2" = 10^2,
                             .default = 1),
            CROPDMG = CROPDMG * cropexp,
            EVTYPE = tolower(EVTYPE),
            year = format(as.Date(BGN_DATE, format = "%m/%d/%Y"), "%Y")) %>%
    select(year, EVTYPE, FATALITIES:PROPDMG, CROPDMG)
head(df, n=3)
```

## Results

Here I calculate the most fatal and harmful disasters. Both most fatal and harmful disaster is tornado. But in terms of economic damage, flood is the most harmful disaster.

```{r, echo=TRUE}
mostfatal <-
df %>%
    group_by(EVTYPE) %>%
    summarise(total_fatal = sum(FATALITIES),
              .groups = 'drop') %>%
    arrange(-total_fatal) %>%
    slice(1:20)
head(mostfatal, n=3)

mostinj <-
df %>%
    group_by(EVTYPE) %>%
    summarise(total_injuries = sum(INJURIES),
              .groups = 'drop') %>%
    arrange(-total_injuries) %>%
    slice(1:20)
head(mostinj, n=3)
```
### A. Most Fatalities by Event Type

```{r linegraph1, echo=TRUE}
# x axis labels are in alphabetic order

library(ggplot2)
ggplot(data = mostfatal, aes(x = as.factor(EVTYPE), 
                            y = total_fatal,
                            group = 1)) +
    geom_line() + geom_point() +
    theme(axis.text.x = element_text(angle = 90)) +
    ggtitle("Most Fatal Events in the US") +
    ylab("Total Fatalities") +
    xlab("Events")


ggplot(data = mostfatal, aes(x = reorder(EVTYPE,total_fatal), 
                            y = total_fatal,
                            group = 1)) +
    geom_line() + geom_point() +
    theme(axis.text.x = element_text(angle = 90)) +
    ggtitle("Most Fatal Events in the US") +
    ylab("Total Fatalities") +
    xlab("Events")



ggplot(data = mostfatal, aes(x = reorder(EVTYPE,total_fatal), 
                            y = total_fatal,
                            group = 1)) +
    geom_bar(stat = "identity")  +
    theme(axis.text.x = element_text(angle = 90)) +
    ggtitle("Most Fatal Events in the US") +
    ylab("Total Fatalities") +
    xlab("Events")
```

### B. Most Injuries by Event Type
```{r linegraph2, echo=TRUE}
ggplot(data = mostinj, aes(x = as.factor(EVTYPE), 
                            y = total_injuries,
                            group = 1)) +
    geom_line() + geom_point() +
    theme(axis.text.x = element_text(angle = 90)) +
    ggtitle("Most Injured Events in the US") +
    ylab("Total Injuries") +
    xlab("Events")
```

### C. Economic Consequencies of Disasters

```{r, echo=TRUE}
df_econ <-
df %>%
    select(-FATALITIES, -INJURIES) %>%
    group_by(EVTYPE) %>%
    summarise(total_propdmg = sum(PROPDMG, na.rm = T),
              total_cropdmg = sum(CROPDMG, na.rm = T),
              total_dmg = total_propdmg + total_cropdmg) %>%
    arrange(-total_dmg) %>%
    slice(1:20) %>%
    pivot_longer(c(total_propdmg:total_dmg), names_to = "type", values_to = "damage_value")

head(df_econ, n=3)
```
```{r linegraph3, echo=TRUE}
ggplot(data = df_econ, aes(x = as.factor(EVTYPE), 
                            y = damage_value/1e9,
                            color = type,
                           group = type)) +
    geom_line() + geom_point() +
    scale_y_continuous(labels = scales::dollar_format(suffix = "B")) +
    theme(axis.text.x = element_text(angle = 90)) +
    ggtitle("Most Economically Harmful Events in the US") +
    ylab("Total Economic Damage") +
    xlab("Events")
```

